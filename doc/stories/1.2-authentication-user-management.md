# <!-- Powered by BMADâ„¢ Core -->

# Story 1.2: Authentication & User Management

## Status
**PENDING** ðŸ”„

## Story
**As a** user,
**I want** to register, login, and manage my account securely,
**so that** my personal health and financial data is protected and accessible only to me.

## Acceptance Criteria
1. Supabase Auth integrated with email/password authentication
2. User registration flow with email verification
3. Login/logout functionality with session management
4. User profile creation automatically triggered on signup
5. Protected routes requiring authentication implemented
6. User profile page with basic information display and edit capability
7. Row Level Security (RLS) policies enabled on profiles table

## Tasks / Subtasks
- [ ] Supabase Auth Integration (AC: 1)
  - [ ] Configure Supabase Auth settings in dashboard
  - [ ] Implement Supabase client and server helpers (lib/supabase/)
  - [ ] Create middleware.ts for auth route protection
  - [ ] Set up authentication context/hooks (use-auth.ts)
- [ ] Registration Flow (AC: 2)
  - [ ] Create register page (app/(auth)/register/page.tsx)
  - [ ] Implement registration form with validation (Zod schema)
  - [ ] Configure email verification in Supabase
  - [ ] Create email verification confirmation page
- [ ] Login/Logout (AC: 3)
  - [ ] Create login page (app/(auth)/login/page.tsx)
  - [ ] Implement login form with email/password
  - [ ] Implement logout functionality
  - [ ] Add forgot password flow
  - [ ] Add password reset page
- [ ] Profile Creation (AC: 4)
  - [ ] Create profiles table in database (schema.ts)
  - [ ] Implement database trigger for auto-profile creation
  - [ ] Set default values (timezone, currency, theme, total_points: 0)
- [ ] Route Protection (AC: 5)
  - [ ] Configure middleware to protect /dashboard routes
  - [ ] Redirect unauthenticated users to /login
  - [ ] Redirect authenticated users from /login to /dashboard
- [ ] Profile Management (AC: 6)
  - [ ] Create profile page (app/(dashboard)/profile/page.tsx)
  - [ ] Display user information (name, email, avatar)
  - [ ] Implement profile edit form
  - [ ] Add avatar upload functionality (Supabase Storage)
  - [ ] Create server action for profile updates
- [ ] Security Policies (AC: 7)
  - [ ] Enable RLS on profiles table
  - [ ] Create policy: users can view own profile
  - [ ] Create policy: users can update own profile
  - [ ] Test RLS policies

## Dev Notes

### Previous Story Insights
**From Story 1.1**: Infrastructure setup completed with Next.js 14, Supabase, and Drizzle ORM configured.

### Data Models
**Database Schema** [Source: database.md]:
```sql
profiles table:
  - id (UUID, FK to auth.users)
  - email (TEXT)
  - full_name (TEXT)
  - avatar_url (TEXT)
  - timezone (TEXT, default: 'UTC')
  - language (TEXT, default: 'en')
  - currency (TEXT, default: 'USD')
  - theme (TEXT, default: 'dark')
  - total_points (INTEGER, default: 0)
  - current_level (TEXT, default: 'Beginner')
  - onboarding_completed (BOOLEAN, default: false)
  - goals (JSONB, default: '[]')
  - created_at (TIMESTAMPTZ)
  - updated_at (TIMESTAMPTZ)
```

### Tech Stack Specifications
**Authentication** [Source: security.md]:
- **Supabase Auth**: Email/password, OAuth (Google, Apple), Magic Link
- **Session Management**: JWT tokens in HTTP-only cookies
- **Password Security**: Bcrypt hashing, minimum 8 characters
- **Rate Limiting**: 5 failed login attempts = 15 min lockout

### File Locations
**Authentication Files** [Source: backend.md]:
- **Middleware**: middleware.ts
- **Auth Pages**: app/(auth)/login/, app/(auth)/register/, app/(auth)/forgot-password/
- **Profile**: app/(dashboard)/profile/page.tsx
- **Supabase Clients**: lib/supabase/client.ts, lib/supabase/server.ts
- **Hooks**: hooks/use-auth.ts
- **Server Actions**: actions/user.ts
- **Types**: types/database.types.ts (Supabase generated)

### Infrastructure Requirements
**Security Configuration** [Source: security.md]:
- HTTPS enforced on all routes
- Secure, HTTP-only cookies for session tokens
- CSRF protection via SameSite cookies
- Environment variables for Supabase keys (NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY)

### Testing Requirements
- [ ] Test registration with valid/invalid emails
- [ ] Test login with correct/incorrect credentials
- [ ] Test email verification flow
- [ ] Test password reset flow
- [ ] Test profile update functionality
- [ ] Test RLS policies (users cannot access other users' data)
- [ ] Test route protection (unauthenticated redirect)

### Technical Constraints
- **Security**: All user data must be protected by RLS
- **Performance**: Auth checks should not slow down page loads (<100ms)
- **UX**: Clear error messages for authentication failures
- **Privacy**: Passwords never stored or logged in plaintext

## Testing
- [ ] Unit tests for auth helper functions
- [ ] Integration tests for registration/login flows
- [ ] E2E tests for complete authentication journey
- [ ] Security tests for RLS policy enforcement
- [ ] Load tests for concurrent login attempts

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial story creation | Dev Team |

## Dev Agent Record
*This section will be populated by the implementing agent*

## QA Results
*This section will be populated by the QA agent after implementation review*
