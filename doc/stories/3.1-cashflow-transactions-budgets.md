# <!-- Powered by BMADâ„¢ Core -->

# Story 3.1: Cashflow Module - Transaction Tracking & Budgets

## Status
**PENDING** ðŸ”„

## Story
**As a** user,
**I want** to track my income and expenses with categories and set monthly budgets,
**so that** I can manage my finances effectively and receive alerts when approaching budget limits.

## Acceptance Criteria
1. User can create custom income/expense categories with icons and colors
2. User can quickly log transactions (<30 seconds) with amount, type, category, date, and description
3. User can view transaction history filtered by date range and type
4. User can set monthly budgets per category
5. User receives in-app alerts when spending reaches 80% and 100% of budget
6. User can view monthly summary showing total income, expenses, and balance
7. System automatically calculates budget progress and remaining amount
8. All financial data protected by RLS policies

## Tasks / Subtasks
- [ ] Database Schema (AC: 8)
  - [ ] Create categories table (user_id, name, type, icon, color, is_system)
  - [ ] Create transactions table with decimal(12,2) for amounts
  - [ ] Create budgets table (category_id, amount, month, alert flags)
  - [ ] Create financial_goals table (for future savings features)
  - [ ] Seed default categories (Food, Transport, Salary, etc.)
  - [ ] Enable RLS on all cashflow tables
  - [ ] Create indexes for date-based queries
- [ ] Transaction Service (AC: 2, 6)
  - [ ] Create TransactionService in services/cashflow/
  - [ ] Implement addTransaction() with validation
  - [ ] Implement getMonthlySummary() aggregating by type
  - [ ] Implement checkBudgetAlert() logic
  - [ ] Award +5 points for logging transactions
- [ ] Budget Service (AC: 4, 5, 7)
  - [ ] Create BudgetService in services/cashflow/
  - [ ] Implement setBudget() with month validation
  - [ ] Implement calculateBudgetProgress()
  - [ ] Implement budget alert triggers (80%, 100%)
  - [ ] Store alert_sent flags to prevent duplicates
- [ ] Server Actions (AC: 2, 4)
  - [ ] Create actions/transactions.ts
  - [ ] Implement addTransaction server action
  - [ ] Implement updateTransaction server action
  - [ ] Implement deleteTransaction server action
  - [ ] Create actions/budgets.ts
  - [ ] Implement setBudget server action
- [ ] Transaction Components (AC: 2, 3)
  - [ ] Create TransactionForm with quick-entry optimizations
  - [ ] Pre-fill today's date and last-used category
  - [ ] Create CategoryPicker dropdown component
  - [ ] Create TransactionList with date grouping
  - [ ] Create TransactionItem showing amount, category, description
  - [ ] Add filter controls (date range, type, category)
- [ ] Budget Components (AC: 4, 5, 7)
  - [ ] Create BudgetCard showing progress bar
  - [ ] Create BudgetForm for setting amounts
  - [ ] Create MonthlySummary dashboard card
  - [ ] Create budget alert notification system
  - [ ] Add visual indicators (red at 100%, orange at 80%)
- [ ] Cashflow Page (AC: 2, 3, 6)
  - [ ] Create app/(dashboard)/cashflow/page.tsx
  - [ ] Display monthly summary at top
  - [ ] Show recent transactions list
  - [ ] Add quick-add transaction FAB button
  - [ ] Create app/(dashboard)/cashflow/budgets/page.tsx
  - [ ] Display all budgets with progress bars

## Dev Notes

### Previous Story Insights
**From Story 2.1**: Gamification integration working via PointsService, RLS policies established, optimistic UI patterns implemented.

### Data Models
**Cashflow Schema** [Source: database.md]:
```sql
categories:
  - id, user_id, name, type ('income'|'expense')
  - icon, color, is_system

transactions:
  - id, user_id, category_id
  - amount (DECIMAL(12,2))
  - type ('income'|'expense')
  - description, transaction_date
  - is_recurring, recurrence_rule
  - tags (TEXT[]), notes

budgets:
  - id, user_id, category_id
  - amount (DECIMAL(12,2))
  - month (DATE - first day of month)
  - alert_80_sent, alert_100_sent

financial_goals:
  - id, user_id, name
  - target_amount, current_amount
  - target_date, status
```

### Tech Stack Specifications
**Business Logic** [Source: backend.md]:
- **Quick Entry**: Form pre-fills with smart defaults (today, last category)
- **Monthly Summary**: SQL aggregation with GROUP BY type
- **Budget Alerts**: Triggered on each transaction if percentage >= threshold
- **Points**: +5 points per transaction logged
- **Budget Check**: SUM(transactions) WHERE category_id AND month = current

### File Locations
**Cashflow Files** [Source: backend.md, frontend.md]:
- **Schema**: lib/db/schema/transactions.ts
- **Services**: services/cashflow/transaction.service.ts, services/cashflow/budget.service.ts
- **Actions**: actions/transactions.ts, actions/budgets.ts
- **Components**: components/cashflow/ (transaction-form, transaction-list, budget-card, monthly-summary)
- **Pages**: app/(dashboard)/cashflow/, app/(dashboard)/cashflow/budgets/
- **Validation**: lib/validations/transaction.ts

### Infrastructure Requirements
- Decimal precision for money (DECIMAL(12,2))
- Indexes on (user_id, transaction_date DESC) for performance
- Date-based queries for monthly calculations
- Alert flags to prevent duplicate notifications

### Testing Requirements
- [ ] Test quick transaction entry (<30 seconds goal)
- [ ] Test monthly summary calculations accuracy
- [ ] Test budget alerts trigger at 80% and 100%
- [ ] Test budget alerts don't duplicate
- [ ] Test transaction filtering by date/type/category
- [ ] Test income/expense categorization
- [ ] Test points awarded on transaction log

### Technical Constraints
- **Performance**: Transaction list should paginate after 50 items
- **UX**: Form should be optimized for mobile quick entry
- **Accuracy**: Financial calculations must use DECIMAL, not FLOAT
- **Privacy**: All amounts and data protected by RLS

## Testing
- [ ] Unit tests for monthly summary calculations
- [ ] Unit tests for budget percentage calculations
- [ ] Integration tests for transaction CRUD
- [ ] E2E test for add transaction â†’ trigger budget alert flow
- [ ] Test decimal precision (no rounding errors)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial story creation | Dev Team |

## Dev Agent Record
*This section will be populated by the implementing agent*

## QA Results
*This section will be populated by the QA agent after implementation review*
