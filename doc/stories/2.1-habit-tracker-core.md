# <!-- Powered by BMADâ„¢ Core -->

# Story 2.1: Habit Tracker Module - Core Features

## Status
**PENDING** ðŸ”„

## Story
**As a** user,
**I want** to create, track, and complete daily habits with streak tracking,
**so that** I can build positive routines and stay motivated through gamification.

## Acceptance Criteria
1. User can create new habits with name, description, category, and schedule (daily/specific days)
2. User can view list of all active habits organized by category
3. User can mark habits as complete for today with visual feedback
4. Streak counter automatically calculates and displays current/longest streaks
5. User can view habit completion calendar showing historical data
6. User receives points (+10) for completing habits
7. Habit completion persists to database and triggers gamification updates
8. RLS policies ensure users only see their own habits

## Tasks / Subtasks
- [ ] Database Schema (AC: 8)
  - [ ] Create habit_categories table with default categories
  - [ ] Create habits table with scheduling fields
  - [ ] Create habit_completions table with unique constraint
  - [ ] Create indexes for performance (user_id, habit_id, completed_date)
  - [ ] Enable RLS on all habit tables
  - [ ] Create RLS policies (view/insert/update/delete own habits)
- [ ] Habit Service Layer (AC: 4, 6, 7)
  - [ ] Create HabitService in services/habits/habit.service.ts
  - [ ] Implement createHabit() with validation
  - [ ] Implement completeHabit() with streak calculation
  - [ ] Implement updateStreak() logic (consecutive day counting)
  - [ ] Integrate with PointsService for +10 points award
  - [ ] Create getTodayHabits() filtering by schedule_days
- [ ] Server Actions (AC: 1, 3, 7)
  - [ ] Create actions/habits.ts
  - [ ] Implement createHabit server action
  - [ ] Implement completeHabit server action with revalidatePath
  - [ ] Implement updateHabit server action
  - [ ] Implement deleteHabit server action
- [ ] UI Components (AC: 2, 3, 5)
  - [ ] Create HabitCard component (components/habits/habit-card.tsx)
  - [ ] Create HabitForm component for create/edit
  - [ ] Create HabitList component with category grouping
  - [ ] Create StreakBadge component showing flame icon + count
  - [ ] Create HabitCalendar component with completion heatmap
  - [ ] Create QuickComplete button with optimistic UI
- [ ] Habits Page (AC: 2, 3)
  - [ ] Create app/(dashboard)/habits/page.tsx
  - [ ] Fetch today's habits server-side
  - [ ] Display habits grouped by category
  - [ ] Show completion status for today
  - [ ] Add "New Habit" button opening modal/page
- [ ] Create/Edit Flow (AC: 1)
  - [ ] Create app/(dashboard)/habits/new/page.tsx
  - [ ] Implement habit creation form with Zod validation
  - [ ] Add category selector (dropdown)
  - [ ] Add day-of-week selector (checkbox group for schedule_days)
  - [ ] Add optional reminder time picker
  - [ ] Handle form submission with loading states

## Dev Notes

### Previous Story Insights
**From Story 1.2**: User authentication is working, RLS patterns established, server actions implemented for profile updates.

### Data Models
**Habit Schema** [Source: database.md]:
```sql
habit_categories:
  - id, name, slug, icon, color, is_system

habits:
  - id, user_id, category_id
  - name, description, icon
  - schedule_type ('daily', 'weekly', 'custom')
  - schedule_days (INTEGER[] - 0=Sun, 6=Sat)
  - reminder_enabled, reminder_time
  - current_streak, longest_streak, total_completions
  - is_active, archived_at
  - created_at, updated_at

habit_completions:
  - id, habit_id
  - completed_date (DATE)
  - notes
  - UNIQUE(habit_id, completed_date)
```

### Tech Stack Specifications
**Business Logic** [Source: backend.md]:
- **Streak Calculation**: Consecutive day counting from completion history
- **Today's Habits**: Filter by schedule_days matching current day-of-week
- **Points Award**: +10 points per habit completion via PointsService
- **Validation**: Zod schema for habit creation (habitSchema)

### File Locations
**Habit Module Files** [Source: backend.md, frontend.md]:
- **Schema**: lib/db/schema/habits.ts
- **Service**: services/habits/habit.service.ts, services/habits/streak.service.ts
- **Actions**: actions/habits.ts
- **Components**: components/habits/ (habit-card, habit-form, habit-list, streak-badge, habit-calendar)
- **Pages**: app/(dashboard)/habits/page.tsx, app/(dashboard)/habits/new/page.tsx
- **Hooks**: hooks/use-habits.ts
- **Validation**: lib/validations/habit.ts

### Infrastructure Requirements
- Database indexes on (user_id, is_active) and (habit_id, completed_date DESC)
- Optimistic UI updates for instant feedback on completion
- revalidatePath('/habits') after mutations

### Testing Requirements
- [ ] Test habit creation with valid/invalid data
- [ ] Test completion marks habit as done for today only
- [ ] Test streak calculation across multiple days
- [ ] Test cannot complete same habit twice in one day
- [ ] Test scheduled habits only show on correct days
- [ ] Test RLS prevents viewing other users' habits
- [ ] Test points awarded on completion

### Technical Constraints
- **Performance**: Habit list should load <500ms
- **UX**: Completion should feel instant (optimistic updates)
- **Data Integrity**: Unique constraint on habit_completions prevents duplicates
- **Extensibility**: Calendar component should support future analytics

## Testing
- [ ] Unit tests for StreakService.calculateStreak()
- [ ] Integration tests for habit CRUD operations
- [ ] E2E test for complete habit creation â†’ completion â†’ streak flow
- [ ] Test edge cases (timezone boundaries, missed days, leap years)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial story creation | Dev Team |

## Dev Agent Record
*This section will be populated by the implementing agent*

## QA Results
*This section will be populated by the QA agent after implementation review*
