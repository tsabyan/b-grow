# <!-- Powered by BMADâ„¢ Core -->

# Story 4.1: Fitness Module - Weight & Workout Tracking

## Status
**PENDING** ðŸ”„

## Story
**As a** user,
**I want** to track my weight, log workouts, and monitor nutrition,
**so that** I can achieve my fitness goals (weight loss, muscle gain, or maintenance).

## Acceptance Criteria
1. User can log daily weight with automatic BMI calculation
2. User can view weight trend chart showing progress over time
3. User can set fitness goals (weight loss, weight gain, muscle building, maintenance)
4. User can log workouts with exercises, sets, reps, and duration
5. User can log meals with calories and macros (protein, carbs, fats)
6. User receives points for logging weight (+10) and workouts (+25)
7. System displays goal progress with estimated timeline to target
8. All fitness data protected by RLS policies

## Tasks / Subtasks
- [ ] Database Schema (AC: 8)
  - [ ] Create weight_logs table (weight, unit, log_date, bmi)
  - [ ] Create body_measurements table (chest, waist, hips, arms, thighs)
  - [ ] Create workouts table (name, type, duration, calories, exercises JSONB)
  - [ ] Create meals table (meal_type, calories, protein, carbs, fats, foods JSONB)
  - [ ] Create fitness_goals table (goal_type, start/target weight, daily calories/protein)
  - [ ] Enable RLS on all fitness tables
  - [ ] Create indexes on (user_id, log_date DESC)
- [ ] Weight Service (AC: 1, 2, 7)
  - [ ] Create WeightService in services/fitness/
  - [ ] Implement logWeight() with BMI auto-calculation
  - [ ] Implement getWeightTrend() for charting
  - [ ] Implement calculateProgress() vs. fitness goal
  - [ ] Award +10 points for weight logging
- [ ] Workout Service (AC: 4, 6)
  - [ ] Create WorkoutService in services/fitness/
  - [ ] Implement logWorkout() with exercises JSONB storage
  - [ ] Award +25 points for workout completion
  - [ ] Implement getWorkoutHistory()
- [ ] Nutrition Service (AC: 5)
  - [ ] Create NutritionService in services/fitness/
  - [ ] Implement logMeal() with macro tracking
  - [ ] Implement getDailyMacros() aggregation
  - [ ] Implement compareToGoal() vs. fitness_goals
- [ ] Server Actions (AC: 1, 4, 5)
  - [ ] Create actions/fitness.ts
  - [ ] Implement logWeight server action
  - [ ] Implement logWorkout server action
  - [ ] Implement logMeal server action
  - [ ] Implement setFitnessGoal server action
- [ ] Weight Components (AC: 1, 2, 3, 7)
  - [ ] Create WeightForm for quick weight logging
  - [ ] Create WeightChart (Recharts line chart)
  - [ ] Create WeightStats showing BMI, change, trend
  - [ ] Create GoalSetter for fitness goals
  - [ ] Create ProgressPhoto upload component (Supabase Storage)
- [ ] Workout Components (AC: 4)
  - [ ] Create WorkoutForm with exercise list
  - [ ] Create ExerciseList with sets/reps inputs
  - [ ] Create WorkoutCard displaying summary
  - [ ] Add workout type selector (strength, cardio, flexibility)
- [ ] Nutrition Components (AC: 5)
  - [ ] Create MealEntry form (meal type, foods, macros)
  - [ ] Create MacroDisplay showing protein/carbs/fats bars
  - [ ] Create DailyNutrition summary
  - [ ] Add meal type selector (breakfast, lunch, dinner, snack)
- [ ] Fitness Page (AC: 1, 2, 3, 7)
  - [ ] Create app/(dashboard)/fitness/page.tsx
  - [ ] Display current weight and goal progress
  - [ ] Show weight trend chart (30 days)
  - [ ] Add quick weight log button
  - [ ] Create app/(dashboard)/fitness/workouts/page.tsx
  - [ ] Create app/(dashboard)/fitness/nutrition/page.tsx

## Dev Notes

### Previous Story Insights
**From Story 3.1**: JSONB columns working for flexible data storage, decimal precision for financial accuracy, points integration established.

### Data Models
**Fitness Schema** [Source: database.md]:
```sql
weight_logs:
  - id, user_id
  - weight (DECIMAL(5,2)), unit ('kg'|'lbs')
  - log_date (DATE), notes
  - UNIQUE(user_id, log_date)

workouts:
  - id, user_id
  - name, workout_type, duration_minutes, calories_burned
  - workout_date, exercises (JSONB), notes

meals:
  - id, user_id
  - meal_type ('breakfast'|'lunch'|'dinner'|'snack')
  - meal_date, meal_time
  - calories, protein, carbs, fats (DECIMAL)
  - description, foods (JSONB)

fitness_goals:
  - id, user_id
  - goal_type ('weight_loss'|'weight_gain'|'maintain'|'muscle_gain')
  - start_weight, target_weight, target_date
  - daily_calories, daily_protein
  - status ('active'|'completed'|'cancelled')
```

### Tech Stack Specifications
**Business Logic** [Source: backend.md]:
- **BMI Calculation**: weight(kg) / height(m)Â²
- **Weight Trend**: Line chart with Recharts
- **Protein Target**: 1.6-2.2g per kg body weight for muscle building
- **Calorie Deficit**: For weight loss (safe: 0.5-1kg/week)
- **Points**: +10 weight log, +25 workout, nutrition logs optional

### File Locations
**Fitness Files** [Source: backend.md, frontend.md]:
- **Schema**: lib/db/schema/fitness.ts
- **Services**: services/fitness/weight.service.ts, services/fitness/workout.service.ts, services/fitness/nutrition.service.ts
- **Actions**: actions/fitness.ts
- **Components**: components/fitness/ (weight-chart, weight-form, workout-card, meal-entry, macro-display)
- **Pages**: app/(dashboard)/fitness/, app/(dashboard)/fitness/workouts/, app/(dashboard)/fitness/nutrition/
- **Validation**: lib/validations/fitness.ts

### Infrastructure Requirements
- Supabase Storage for progress photos (before/after)
- JSONB columns for flexible exercise and food data
- Recharts for weight trend visualization
- One weight log per day (UNIQUE constraint)

### Testing Requirements
- [ ] Test BMI calculation accuracy
- [ ] Test weight trend chart renders correctly
- [ ] Test workout logging with multiple exercises
- [ ] Test meal logging with macro calculations
- [ ] Test goal progress calculations
- [ ] Test cannot log multiple weights in same day
- [ ] Test points awarded correctly

### Technical Constraints
- **Performance**: Chart should render smoothly with 90+ data points
- **UX**: Weight logging should be very quick (FAB button)
- **Data Flexibility**: JSONB for exercises/foods allows custom entries
- **Privacy**: Progress photos stored privately in Supabase Storage

## Testing
- [ ] Unit tests for BMI calculation
- [ ] Unit tests for goal progress calculations
- [ ] Integration tests for weight/workout/meal CRUD
- [ ] E2E test for complete fitness journey (set goal â†’ log weight â†’ see progress)
- [ ] Visual regression tests for weight chart

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial story creation | Dev Team |

## Dev Agent Record
*This section will be populated by the implementing agent*

## QA Results
*This section will be populated by the QA agent after implementation review*
